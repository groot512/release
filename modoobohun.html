<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>모두의보훈 마켓 - Control Center Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Kakao Maps SDK -->
    <!-- ⚠️ IMPORTANT: Replace 'YOUR_KAKAO_API_KEY' with your actual Kakao JavaScript Key -->
    <!-- 도메인이 등록되어 있어야 지도가 정상적으로 보입니다. -->
    <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=YOUR_KAKAO_API_KEY"></script>

    <style>
        /* Custom Animations & Styles */
        body {
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif;
            background-color: #0f172a; /* slate-900 */
            color: white;
            overflow: hidden;
        }

        /* Glassmorphism Panel */
        .glass-panel {
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.36);
        }

        /* Map Custom Overlay Style */
        .custom-overlay {
            position: relative;
            bottom: 10px;
            border-radius: 6px;
            /* border: 1px solid #ccc; */
            /* box-shadow: 0px 1px 2px #888; */
            background: rgba(30, 41, 59, 0.9); /* slate-800 */
            border: 1px solid rgba(71, 85, 105, 0.5);
            color: white;
            padding: 4px 8px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(4px);
            transition: transform 0.2s;
        }
        .custom-overlay:hover {
            transform: scale(1.1);
            background: rgba(15, 23, 42, 1);
            z-index: 50;
        }
        .custom-overlay::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 6px 4px 0;
            border-style: solid;
            border-color: rgba(30, 41, 59, 0.9) transparent transparent transparent;
            display: block;
            width: 0;
        }

        /* Pulse Ring for Map */
        @keyframes pulse-ring {
            0% { transform: scale(0.33); opacity: 1; }
            80%, 100% { opacity: 0; }
        }
        .pulse-ring {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 30px; height: 30px;
            border-radius: 50%;
            background-color: rgba(59, 130, 246, 0.5);
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
            pointer-events: none;
        }
        
        /* Scrollbar Hiding */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Marquee Animation */
        @keyframes marquee {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .animate-marquee {
            animation: marquee 30s linear infinite;
            white-space: nowrap;
            display: inline-block;
        }

        /* Map Grid Effect */
        .bg-grid {
            background-image: linear-gradient(rgba(255, 255, 255, 0.1) 1px, transparent 1px), 
                            linear-gradient(90deg, rgba(255, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        /* Custom Scroll for Modal */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scroll::-webkit-scrollbar-track {
            background: rgba(30, 41, 59, 0.5);
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.8);
            border-radius: 10px;
        }
        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: rgba(99, 102, 241, 0.5);
        }
    </style>
</head>
<body class="selection:bg-blue-500 selection:text-white">

    <!-- Background Grid -->
    <div class="fixed inset-0 pointer-events-none opacity-10 bg-grid"></div>

    <!-- Header -->
    <header class="relative z-10 flex justify-between items-center px-8 py-6 glass-panel border-b border-slate-700">
        <div class="flex items-center gap-4">
            <div class="w-12 h-12 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/30">
                <span class="text-2xl font-bold">M</span>
            </div>
            <div>
                <h1 class="text-3xl font-bold tracking-tight bg-gradient-to-r from-white to-slate-400 bg-clip-text text-transparent">
                    모두의보훈 마켓
                </h1>
                <p class="text-blue-400 text-sm font-medium tracking-wider">CONTROL CENTER DASHBOARD</p>
            </div>
        </div>
        
        <div class="flex items-center gap-4">
            <button id="ai-report-btn" class="flex items-center gap-2 px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-full text-sm font-bold text-white transition-all border border-slate-500/50 cursor-pointer group">
                <i data-lucide="file-text" class="w-4 h-4 text-blue-300 group-hover:text-white transition-colors"></i>
                <span>AI 보고서 작성</span>
            </button>

            <button id="ai-btn" class="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-500 rounded-full text-sm font-bold text-white transition-all shadow-[0_0_15px_rgba(79,70,229,0.5)] hover:shadow-[0_0_25px_rgba(79,70,229,0.8)] border border-indigo-400/30 cursor-pointer">
                <i data-lucide="sparkles" class="w-4 h-4 text-yellow-300"></i>
                <span>AI 경영 인사이트</span>
            </button>

            <div class="w-px h-10 bg-slate-700 mx-2"></div>

            <div class="text-right">
                <p id="current-date" class="text-slate-400 text-sm">Loading...</p>
                <p id="current-time" class="text-3xl font-mono font-bold text-blue-300">00:00</p>
            </div>
            <div class="h-10 w-10 rounded-full bg-slate-800 border border-slate-600 flex items-center justify-center relative">
                <i data-lucide="bell" class="text-slate-300 w-5 h-5"></i>
                <span class="absolute top-0 right-0 w-3 h-3 bg-red-500 rounded-full animate-pulse"></span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="relative z-10 p-8 grid grid-cols-12 gap-8 h-[calc(100vh-110px)]">
        
        <!-- Left Column: Key Stats -->
        <div class="col-span-3 flex flex-col gap-6">
            <!-- 가입자 현황 -->
            <div class="glass-panel rounded-2xl p-6 flex-1 flex flex-col justify-between relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i data-lucide="users" width="120" height="120"></i>
                </div>
                <div>
                    <h2 class="text-slate-400 font-medium flex items-center gap-2 mb-4">
                        <i data-lucide="user-check" class="w-5 h-5 text-blue-400"></i> 가입자 현황
                    </h2>
                    
                    <div class="space-y-5">
                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <span class="text-lg text-slate-300">보훈대상자</span>
                                <span class="text-3xl font-bold text-white">12,540<span class="text-sm text-slate-500 font-normal ml-1">명</span></span>
                            </div>
                            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-500 w-[65%] shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <span class="text-lg text-slate-300">보훈가족</span>
                                <span class="text-3xl font-bold text-white">8,420<span class="text-sm text-slate-500 font-normal ml-1">명</span></span>
                            </div>
                            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-indigo-500 w-[45%]"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between items-end mb-1">
                                <span class="text-lg text-slate-300">제대군인</span>
                                <span class="text-3xl font-bold text-white">5,200<span class="text-sm text-slate-500 font-normal ml-1">명</span></span>
                            </div>
                            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-teal-500 w-[30%]"></div>
                            </div>
                        </div>
                         <div>
                            <div class="flex justify-between items-end mb-1">
                                <span class="text-lg text-slate-300">참여기업</span>
                                <span class="text-3xl font-bold text-white">1,250<span class="text-sm text-slate-500 font-normal ml-1">개</span></span>
                            </div>
                            <div class="h-2 bg-slate-700 rounded-full overflow-hidden">
                                <div class="h-full bg-orange-500 w-[15%]"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-6 pt-6 border-t border-slate-700">
                    <div class="flex justify-between text-sm text-slate-400">
                        <span>전일 대비</span>
                        <span class="text-green-400 flex items-center gap-1">▲ 124명 증가</span>
                    </div>
                </div>
            </div>

            <!-- 매니저 현황 -->
            <div class="glass-panel rounded-2xl p-6 h-1/3 flex flex-col justify-center relative overflow-hidden">
                <div class="absolute -right-4 -bottom-4 opacity-10">
                    <i data-lucide="users" width="100" height="100"></i>
                </div>
                <h2 class="text-slate-400 font-medium flex items-center gap-2 mb-2">
                    <i data-lucide="activity" class="w-5 h-5 text-green-400"></i> 매니저 등록 현황
                </h2>
                <div class="flex items-baseline gap-2">
                    <span class="text-6xl font-bold text-white tracking-tighter">86</span>
                    <span class="text-xl text-slate-400">명</span>
                </div>
                <p class="text-slate-500 text-sm mt-2">현재 활동중인 지역 매니저</p>
            </div>
        </div>

        <!-- Center Column: Map (KAKAO MAP Integrated) -->
        <div class="col-span-6 glass-panel rounded-2xl p-1 relative flex flex-col">
            <div class="absolute top-6 left-6 z-20 pointer-events-none">
                <h2 class="text-2xl font-bold text-white flex items-center gap-2 drop-shadow-md">
                    <i data-lucide="building" class="text-blue-400"></i> 상생지원센터 현황
                </h2>
                <div class="flex items-center gap-4 mt-2 pointer-events-auto">
                    <div class="px-3 py-1 bg-slate-800/90 rounded-full border border-slate-600 text-sm backdrop-blur-md">
                        <span class="text-slate-400 mr-2">전체 센터</span>
                        <span class="text-white font-bold">225개</span>
                    </div>
                    <div class="px-3 py-1 bg-blue-900/80 rounded-full border border-blue-600 text-sm backdrop-blur-md">
                        <span class="text-blue-200 mr-2">등록 완료</span>
                        <span class="text-white font-bold">142개</span>
                    </div>
                </div>
            </div>

            <!-- Map Container -->
            <div class="flex-1 relative w-full h-full bg-slate-900/50 rounded-xl overflow-hidden">
                
                <!-- 1. Real Kakao Map Container -->
                <div id="kakao-map" class="w-full h-full z-0"></div>

                <!-- 2. Fallback SVG Map (Shown if Kakao Map fails/no key) -->
                <div id="fallback-map" class="absolute inset-0 w-full h-full bg-slate-900 z-0 hidden">
                    <svg viewBox="0 0 400 500" class="w-full h-full opacity-30 drop-shadow-2xl transform scale-90 origin-center">
                        <filter id="glow">
                            <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                        <path 
                          d="M120,80 L180,80 L220,100 L260,90 L280,120 L270,160 L300,180 L290,250 L320,270 L300,350 L250,380 L200,390 L150,410 L100,380 L80,300 L60,250 L80,180 L70,130 Z" 
                          fill="#1e293b" 
                          stroke="#3b82f6" 
                          stroke-width="2"
                          filter="url(#glow)"
                        />
                        <path d="M60,150 L320,150 M60,250 L320,250 M60,350 L320,350" stroke="#334155" stroke-width="0.5" />
                        <path d="M150,80 L150,410 M250,80 L250,410" stroke="#334155" stroke-width="0.5" />
                    </svg>
                    <div id="map-dots-container"></div>
                    <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center pointer-events-none">
                        <p class="text-slate-500 text-sm">지도를 불러올 수 없습니다.<br>(API Key 확인 필요)</p>
                    </div>
                </div>

                <!-- Helper Text -->
                <div class="absolute top-6 right-6 text-right pointer-events-none z-20">
                    <p class="text-xs text-slate-500 bg-slate-900/80 px-2 py-1 rounded border border-slate-700">
                        <span class="text-blue-400 font-bold">TIP:</span> 지도상의 점을 클릭하여<br>지역별 AI 전략을 확인하세요.
                    </p>
                </div>

                <!-- Realtime Status Box -->
                <div class="absolute bottom-6 right-6 bg-slate-800/80 p-4 rounded-lg border border-slate-700 backdrop-blur-sm z-20">
                    <div class="text-xs text-slate-400 mb-2">실시간 등록 현황</div>
                    <div class="flex items-center gap-2 text-sm font-mono">
                        <span class="text-green-400">●</span> 
                        <span id="map-ticker-text" class="text-white">데이터 로딩중...</span>
                    </div>
                </div>
            </div>

            <!-- AI Insight Modal -->
            <div id="ai-modal" class="hidden absolute inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm transition-all">
                <div class="w-3/4 bg-slate-900 border border-indigo-500/50 rounded-2xl shadow-[0_0_50px_rgba(79,70,229,0.3)] overflow-hidden flex flex-col max-h-[80vh]">
                    <div class="bg-indigo-900/30 p-4 border-b border-indigo-500/30 flex justify-between items-center shrink-0">
                        <div class="flex items-center gap-2">
                            <i id="modal-icon" data-lucide="sparkles" class="text-yellow-400 w-5 h-5 animate-pulse"></i>
                            <h3 id="modal-title" class="text-lg font-bold text-white">Gemini AI 경영 인사이트</h3>
                        </div>
                        <button id="close-modal-btn" class="text-slate-400 hover:text-white cursor-pointer">
                            <i data-lucide="x" size="24"></i>
                        </button>
                    </div>
                    <div class="p-8 flex-1 overflow-y-auto flex items-center justify-center relative custom-scroll">
                        <div id="ai-loading" class="hidden flex-col items-center gap-4">
                            <i data-lucide="loader-2" class="w-12 h-12 text-indigo-400 animate-spin"></i>
                            <p id="loading-text" class="text-indigo-200 animate-pulse">데이터 분석 중입니다...</p>
                        </div>
                        <div id="ai-content" class="text-lg leading-relaxed text-slate-100 whitespace-pre-line">
                            <!-- Text will be injected here -->
                        </div>
                        <div id="ai-error" class="hidden text-red-400 text-center"></div>

                        <div class="absolute -top-10 -left-10 w-32 h-32 bg-indigo-500/20 rounded-full blur-3xl pointer-events-none"></div>
                        <div class="absolute -bottom-10 -right-10 w-32 h-32 bg-blue-500/20 rounded-full blur-3xl pointer-events-none"></div>
                    </div>
                    <div class="bg-slate-950/50 p-3 text-center text-xs text-slate-500 border-t border-slate-800 shrink-0">
                        Powered by Google Gemini AI
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Merchants & List -->
        <div class="col-span-3 flex flex-col gap-6">
            <!-- 가맹점 현황 -->
            <div class="glass-panel rounded-2xl p-6 flex flex-col relative overflow-hidden">
                <div class="absolute -right-6 -top-6 opacity-5 rotate-12">
                    <i data-lucide="store" width="150" height="150"></i>
                </div>
                <h2 class="text-slate-400 font-medium flex items-center gap-2 mb-4">
                    <i data-lucide="store" class="w-5 h-5 text-orange-400"></i> 가맹점 현황
                </h2>
                
                <div class="mb-6">
                    <p class="text-slate-400 text-sm mb-1">총 가맹점</p>
                    <div class="text-4xl font-bold text-white">15,230 <span class="text-base font-normal text-slate-500">개소</span></div>
                </div>

                <div class="bg-slate-800/50 rounded-xl p-4 border border-slate-700 flex items-center gap-4">
                    <div class="w-12 h-12 bg-green-700 rounded-lg flex items-center justify-center font-bold text-white text-xl shadow-lg">7</div>
                    <div class="flex-1">
                        <div class="text-slate-300 font-medium">세븐일레븐</div>
                        <div class="text-2xl font-bold text-white">13,000</div>
                    </div>
                    <div class="text-xs text-green-400 bg-green-400/10 px-2 py-1 rounded">85%</div>
                </div>
                <div class="mt-4 bg-slate-800/50 rounded-xl p-4 border border-slate-700 flex items-center gap-4">
                    <div class="w-12 h-12 bg-indigo-700 rounded-lg flex items-center justify-center font-bold text-white shadow-lg">
                        <i data-lucide="store" size="20"></i>
                    </div>
                    <div class="flex-1">
                        <div class="text-slate-300 font-medium">일반 가맹점</div>
                        <div class="text-2xl font-bold text-white">2,230</div>
                    </div>
                </div>
            </div>

            <!-- 최근 등록 리스트 -->
            <div class="glass-panel rounded-2xl p-0 flex-1 flex flex-col overflow-hidden">
                <div class="p-4 border-b border-slate-700 bg-slate-800/30">
                    <h2 class="text-slate-300 font-medium flex items-center gap-2">
                        <i data-lucide="clock" class="w-4 h-4 text-blue-400"></i> 최근 등록/활동 센터
                    </h2>
                </div>
                <div class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar relative" id="recent-list-container">
                    <div class="absolute top-0 left-0 w-full h-4 bg-gradient-to-b from-slate-900/20 to-transparent pointer-events-none"></div>
                    <div class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-slate-900 to-transparent pointer-events-none"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="fixed bottom-0 w-full bg-slate-900 border-t border-slate-800 py-2 px-4 overflow-hidden whitespace-nowrap z-50">
        <div class="animate-marquee text-sm text-slate-400">
            <span class="mx-4 text-blue-400 font-bold">[공지]</span> 2025년 상생관리지원센터 2차 모집이 시작되었습니다.
            <span class="mx-8 text-slate-600">|</span>
            <span class="mx-4 text-blue-400 font-bold">[뉴스]</span> 세븐일레븐 가맹점 13,000호점 돌파 기념 이벤트 진행 중
            <span class="mx-8 text-slate-600">|</span>
            <span class="mx-4 text-blue-400 font-bold">[업데이트]</span> 관리자 대시보드 v2.1 시스템 안정화 패치 완료
            <span class="mx-8 text-slate-600">|</span>
            <span class="mx-4 text-blue-400 font-bold">[현황]</span> 현재 전국 225개 센터 중 142개 센터 등록 완료 (63%)
        </div>
    </footer>

    <!-- Main Script -->
    <script>
        // --- Data Configuration (Updated with Lat/Lng) ---
        const REGIONS = [
            { id: 'seoul', name: '서울', lat: 37.5665, lng: 126.9780, active: true, count: 25, top: '25%', left: '30%' },
            { id: 'gyeonggi', name: '경기', lat: 37.4138, lng: 127.5183, active: true, count: 45, top: '28%', left: '35%' },
            { id: 'incheon', name: '인천', lat: 37.4563, lng: 126.7052, active: true, count: 10, top: '25%', left: '25%' },
            { id: 'gangwon', name: '강원', lat: 37.8228, lng: 128.1555, active: true, count: 18, top: '20%', left: '60%' },
            { id: 'chungnam', name: '충남', lat: 36.6588, lng: 126.6728, active: true, count: 15, top: '45%', left: '25%' },
            { id: 'daejeon', name: '대전', lat: 36.3504, lng: 127.3845, active: true, count: 5, top: '48%', left: '35%' },
            { id: 'chungbuk', name: '충북', lat: 36.6350, lng: 127.4914, active: true, count: 11, top: '40%', left: '45%' },
            { id: 'jeonbuk', name: '전북', lat: 35.7175, lng: 127.1530, active: true, count: 14, top: '60%', left: '30%' },
            { id: 'gwangju', name: '광주', lat: 35.1595, lng: 126.8526, active: true, count: 5, top: '70%', left: '28%' },
            { id: 'jeonnam', name: '전남', lat: 34.8163, lng: 126.4629, active: true, count: 22, top: '78%', left: '25%' },
            { id: 'gyeongbuk', name: '경북', lat: 36.5760, lng: 128.5056, active: true, count: 29, top: '50%', left: '65%' },
            { id: 'daegu', name: '대구', lat: 35.8714, lng: 128.6014, active: true, count: 9, top: '58%', left: '60%' },
            { id: 'ulsan', name: '울산', lat: 35.5384, lng: 129.3114, active: true, count: 5, top: '62%', left: '75%' },
            { id: 'busan', name: '부산', lat: 35.1796, lng: 129.0756, active: true, count: 16, top: '70%', left: '70%' },
            { id: 'gyeongnam', name: '경남', lat: 35.2383, lng: 128.6922, active: true, count: 18, top: '68%', left: '55%' },
            { id: 'jeju', name: '제주', lat: 33.4996, lng: 126.5312, active: true, count: 2, top: '90%', left: '20%' },
        ];

        const RECENT_CENTERS = [
            "서울은평", "서울서대문", "서울종로", "서울마포", "경기수원장안", "경기화성", 
            "강원춘천", "대전서구", "충남천안", "전주덕진", "광주북구", "대구수성", "부산해운대", 
            "경남창원", "제주시", "인천미추홀", "경기용인수지", "강원원주"
        ];

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initClock();
            renderRecentList();
            startTicker();
            setupAI();
            initKakaoMap(); // Try initializing Kakao Map
        });

        // --- Clock Logic ---
        function initClock() {
            const updateTime = () => {
                const now = new Date();
                const dateStr = now.toLocaleDateString('ko-KR', { 
                    year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' 
                });
                const timeStr = now.toLocaleTimeString('ko-KR', { 
                    hour: '2-digit', minute: '2-digit' 
                });
                
                document.getElementById('current-date').textContent = dateStr;
                document.getElementById('current-time').textContent = timeStr;
            };
            updateTime();
            setInterval(updateTime, 1000);
        }

        // --- Kakao Map Logic ---
        function initKakaoMap() {
            const container = document.getElementById('kakao-map');
            const fallback = document.getElementById('fallback-map');

            // Check if Kakao SDK is loaded
            if (typeof kakao !== 'undefined' && kakao.maps) {
                const options = {
                    center: new kakao.maps.LatLng(36.3, 127.8), // Center of Korea
                    level: 13 // Zoom level
                };
                const map = new kakao.maps.Map(container, options);
                
                // Disable scroll zoom to prevent accidental zooming on dashboard
                map.setZoomable(false); 

                // Render Custom Overlays
                REGIONS.forEach(region => {
                    const content = `
                        <div class="custom-overlay" onclick="triggerRegionalAIByName('${region.name}', ${region.count})">
                            <span class="text-slate-300 font-medium tracking-tight">${region.name}</span>
                            <span class="text-blue-400 font-bold">${region.count}</span>
                            ${region.active ? '<div class="pulse-ring"></div>' : ''}
                        </div>
                    `;

                    const position = new kakao.maps.LatLng(region.lat, region.lng);
                    const customOverlay = new kakao.maps.CustomOverlay({
                        position: position,
                        content: content,
                        yAnchor: 1 
                    });
                    customOverlay.setMap(map);
                });
            } else {
                // Fallback to SVG if Kakao not loaded
                console.warn("Kakao Maps SDK not loaded. Showing fallback map.");
                container.style.display = 'none';
                fallback.classList.remove('hidden');
                renderFallbackDots();
            }
        }

        // --- Fallback Map Rendering Logic (Original SVG Dots) ---
        function renderFallbackDots() {
            const container = document.getElementById('map-dots-container');
            container.innerHTML = ''; 
            
            REGIONS.forEach(region => {
                const dotWrapper = document.createElement('div');
                dotWrapper.className = 'absolute flex items-center justify-center cursor-pointer hover:scale-110 transition-transform duration-300 z-10';
                dotWrapper.style.top = region.top;
                dotWrapper.style.left = region.left;
                
                dotWrapper.addEventListener('click', (e) => {
                    e.stopPropagation();
                    triggerRegionalAI(region);
                });

                if (region.active) {
                    const ring = document.createElement('div');
                    ring.className = 'pulse-ring bg-blue-500'; // Using css class defined in style
                    ring.style.position = 'absolute'; // Force position for fallback
                    ring.style.top = '0'; ring.style.left = '0'; ring.style.right = '0'; ring.style.bottom = '0';
                    dotWrapper.appendChild(ring);
                }

                const coreContainer = document.createElement('div');
                coreContainer.className = 'relative w-4 h-4 flex items-center justify-center';
                const dot = document.createElement('div');
                dot.className = `w-3 h-3 rounded-full border-2 border-slate-900 z-10 ${region.active ? 'bg-blue-400' : 'bg-slate-600'}`;
                coreContainer.appendChild(dot);
                dotWrapper.appendChild(coreContainer);

                // Label for Fallback
                const label = document.createElement('div');
                label.className = 'absolute left-3 top-0 ml-1 px-2 py-0.5 bg-slate-800/90 border border-slate-600 rounded shadow-lg flex items-center gap-1.5 whitespace-nowrap backdrop-blur-sm hover:bg-slate-700 transition-colors';
                label.innerHTML = `
                    <span class="text-slate-300 text-[11px] font-medium tracking-tight">${region.name}</span>
                    <span class="text-blue-400 text-[11px] font-bold">${region.count}</span>
                `;
                dotWrapper.appendChild(label);
                container.appendChild(dotWrapper);
            });
        }

        // --- Recent List Rendering ---
        function renderRecentList() {
            const container = document.getElementById('recent-list-container');
            const topGrad = '<div class="absolute top-0 left-0 w-full h-4 bg-gradient-to-b from-slate-900/20 to-transparent pointer-events-none"></div>';
            const bottomGrad = '<div class="absolute bottom-0 left-0 w-full h-12 bg-gradient-to-t from-slate-900 to-transparent pointer-events-none"></div>';
            
            let listHtml = '';
            for (let i = 0; i < 8; i++) {
                const center = RECENT_CENTERS[i % RECENT_CENTERS.length];
                const isFirst = i === 0;
                listHtml += `
                    <div class="flex items-center justify-between p-3 rounded-lg bg-slate-800/40 border border-slate-700/50 hover:bg-slate-700/50 transition-colors">
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full ${isFirst ? 'bg-green-400 animate-pulse' : 'bg-slate-500'}"></div>
                            <div>
                                <div class="text-sm font-medium text-slate-200">${center}</div>
                                <div class="text-xs text-slate-500">상생지원센터 ${101 + i}호</div>
                            </div>
                        </div>
                        <span class="text-xs text-slate-400">${i * 12 + 2}분 전</span>
                    </div>
                `;
            }
            container.innerHTML = topGrad + listHtml + bottomGrad;
        }

        // --- Ticker Logic ---
        function startTicker() {
            const tickerEl = document.getElementById('map-ticker-text');
            let index = 0;
            const update = () => {
                tickerEl.textContent = `${RECENT_CENTERS[index]} 센터 등록 완료...`;
                index = (index + 1) % RECENT_CENTERS.length;
            };
            update();
            setInterval(update, 3000);
        }

        // --- Shared AI Function ---
        async function callGemini(prompt, onComplete) {
            const apiKey = ""; // API Key injected by environment
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: prompt }] }] };

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (text) onComplete(text);
                else throw new Error("No content");
            } catch (err) {
                console.error(err);
                throw err;
            }
        }

        // --- AI Features Logic ---
        let triggerRegionalAI; // Function reference
        window.triggerRegionalAIByName = (name, count) => {
             // Helper for Kakao Map onclick string
             triggerRegionalAI({name, count});
        };

        function setupAI() {
            const modal = document.getElementById('ai-modal');
            const closeBtn = document.getElementById('close-modal-btn');
            const loadingEl = document.getElementById('ai-loading');
            const contentEl = document.getElementById('ai-content');
            const errorEl = document.getElementById('ai-error');
            const modalTitle = document.getElementById('modal-title');
            const loadingText = document.getElementById('loading-text');

            const openModal = (title, iconName, loadingMsg) => {
                modal.classList.remove('hidden');
                loadingEl.classList.remove('hidden');
                loadingEl.classList.add('flex');
                contentEl.textContent = '';
                errorEl.classList.add('hidden');
                modalTitle.textContent = title;
                loadingText.textContent = loadingMsg;
            };

            closeBtn.addEventListener('click', () => modal.classList.add('hidden'));

            // 1. Executive Insight
            document.getElementById('ai-btn').addEventListener('click', async () => {
                openModal("Gemini AI 경영 인사이트", "sparkles", "전체 데이터 분석 중입니다...");
                const currentStats = {
                    members: "총 27,410명 (참여기업 1,250 포함)",
                    centers: "225개 중 142개 등록",
                    merchants: "15,230개소",
                    trend: "전일 대비 가입자 124명 증가"
                };
                const prompt = `
                  당신은 '모두의보훈' 수석 데이터 분석가입니다. 
                  아래 데이터를 바탕으로 경영진에게 보고할 3문장의 핵심 인사이트를 작성하세요.
                  전문적이고 긍정적인 톤을 유지하세요.
                  데이터: ${JSON.stringify(currentStats)}
                `;
                try {
                    await callGemini(prompt, (text) => {
                        loadingEl.classList.add('hidden');
                        loadingEl.classList.remove('flex');
                        typeWriter(text, contentEl);
                    });
                } catch(e) {
                    showError(e);
                }
            });

            // 2. Daily Report Generator
            document.getElementById('ai-report-btn').addEventListener('click', async () => {
                openModal("AI 일일 업무 보고서 생성", "file-text", "보고서 초안 작성 중입니다...");
                const prompt = `
                  당신은 전문 비즈니스 전략가입니다. '모두의보훈' 플랫폼의 오늘자 '일일 업무 보고서'를 작성해주세요.
                  [데이터] 가입자: 26,160명, 센터: 142개/225개, 가맹점: 15,230개.
                  [작성 양식] 1. 개요 2. 주요 지표 3. 특이사항 4. 향후 제언.
                  한국어 비즈니스 보고서 스타일로 작성하세요.
                `;
                try {
                    await callGemini(prompt, (text) => {
                        loadingEl.classList.add('hidden');
                        loadingEl.classList.remove('flex');
                        typeWriter(text, contentEl);
                    });
                } catch(e) {
                    showError(e);
                }
            });

            // 3. Regional Strategy
            triggerRegionalAI = async (region) => {
                openModal(`${region.name} 지역 AI 전략 분석`, "map-pin", `${region.name} 지역 데이터 분석 중...`);
                const prompt = `
                  당신은 지역 상권 분석 전문가입니다. '${region.name}' 지역(센터 ${region.count}개)의 운영 전략을 제안해주세요.
                  이 지역 활성화를 위한 구체적인 마케팅 전략 2가지를 한국어로 제안하세요.
                `;
                try {
                    await callGemini(prompt, (text) => {
                        loadingEl.classList.add('hidden');
                        loadingEl.classList.remove('flex');
                        typeWriter(text, contentEl);
                    });
                } catch(e) {
                    showError(e);
                }
            };

            const typeWriter = (text, element) => {
                let i = 0;
                element.innerHTML = ''; 
                const speed = 10; 
                const type = () => {
                    if (i < text.length) {
                        element.textContent += text.charAt(i);
                        i++;
                        setTimeout(type, speed);
                    }
                };
                type();
            };

            const showError = (err) => {
                loadingEl.classList.add('hidden');
                loadingEl.classList.remove('flex');
                errorEl.classList.remove('hidden');
                errorEl.textContent = "AI 서비스 연결에 실패했습니다. 잠시 후 다시 시도해주세요.";
            };
        }
    </script>
</body>
</html>
